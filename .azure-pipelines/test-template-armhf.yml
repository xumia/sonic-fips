# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

parameters:
  - name: arch
    type: string
    default: armhf
  - name: image
    type: string
    default: publicmirror.azurecr.io/multiarch/debian-debootstrap:armhf-bullseye

jobs:
- job:
  displayName: Qemu-build-and-test-${{ parameters.arch }}
  timeoutInMinutes: 600
  steps:
  - script: |
      ip a show dev eth0
      sudo rm -rf $(ls -A1)
    displayName: 'Clean Workspace'
  - checkout: self
    submodules: true
  - script: |
      pushd src/SymCrypt
      git submodule update --init -- 3rdparty/jitterentropy-library
    displayName: 'Checkout submodule'
  - script: |
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes --credential yes
      sudo pip3 install j2cli
      pushd .azure-pipelines
      DEFAULT_CONTAINER_REGISTRY=publicmirror.azurecr.io/ ARCH=armhf DIST=bullseye j2 Dockerfile.j2 > Dockerfile
      docker build --build-arg user=$USER --build-arg uid=$(id -u) --build-arg guid=$(id -g) --build-arg hostname=$HOSTNAME -t build-agent .
      popd
  - script: |
      docker run --rm --privileged -v $(pwd):/work -w /work build-agent .azure-pipelines/test-multiarch.sh
    displayName: 'Run build and test'
