# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

parameters:
  - name: arch
    type: string
    default: armhf
  - name: image
    type: string
    default: publicmirror.azurecr.io/multiarch/debian-debootstrap:armhf-bullseye

jobs:
- job:
  displayName: Build-and-test-${{ parameters.arch }}
  timeoutInMinutes: 600
  steps:
  - script: |
      ip a show dev eth0
      sudo rm -rf $(ls -A1)
    displayName: 'Clean Workspace'
  - checkout: self
    submodules: true
  - script: |
      (cd src/SymCrypt; git submodule update --init -- 3rdparty/jitterentropy-library)
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes --credential yes
      docker run --rm --privileged -v $(pwd):/work -w /work ${{ parameters.image }} .azure-pipelines/test-multiarch.sh
    displayName: 'Run build and test'
